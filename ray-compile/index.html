

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="谭新宇">
  <meta name="keywords" content="">
  
    <meta name="description" content="背景Ray 官方提供了安装文档和编译文档，涵盖了多种预构建方案——从稳定的发行版本、到日常构建版本，甚至支持主分支上任意 commit 的构建版本。在多平台、多 Python 版本和多芯片架构的组合下，这些预构建方案在大多数情况下都能满足需求。 但当涉及到在生产环境中维护 HotFix 版本时，从源码编译就成了必不可少的技能。特别是在一些企业环境中，你可能面临的是在 CentOS 8 这样的老系统">
<meta property="og:type" content="article">
<meta property="og:title" content="Ray 编译踩坑记：老版本在老系统上的编译之路">
<meta property="og:url" content="https://tanxinyu.work/ray-compile/index.html">
<meta property="og:site_name" content="谭新宇的博客">
<meta property="og:description" content="背景Ray 官方提供了安装文档和编译文档，涵盖了多种预构建方案——从稳定的发行版本、到日常构建版本，甚至支持主分支上任意 commit 的构建版本。在多平台、多 Python 版本和多芯片架构的组合下，这些预构建方案在大多数情况下都能满足需求。 但当涉及到在生产环境中维护 HotFix 版本时，从源码编译就成了必不可少的技能。特别是在一些企业环境中，你可能面临的是在 CentOS 8 这样的老系统">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://picx.zhimg.com/70/v2-9a0e0a9de2e3d8ac38522272dcfeb2d6_1440w.avis?source=172ae18b&biz_tag=Post">
<meta property="article:published_time" content="2025-12-06T06:47:04.000Z">
<meta property="article:modified_time" content="2025-12-08T15:27:39.014Z">
<meta property="article:author" content="谭新宇">
<meta property="article:tag" content="开发工具配置">
<meta property="article:tag" content="分布式计算">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://picx.zhimg.com/70/v2-9a0e0a9de2e3d8ac38522272dcfeb2d6_1440w.avis?source=172ae18b&biz_tag=Post">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Ray 编译踩坑记：老版本在老系统上的编译之路 - 谭新宇的博客</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />

  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"tanxinyu.work","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"gtag":null,"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 7.0.0"><link rel="alternate" href="/atom.xml" title="谭新宇的博客" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>TXY</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/blog-background.jpeg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Ray 编译踩坑记：老版本在老系统上的编译之路"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-12-06 14:47" pubdate>
          2025年12月6日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          42k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          131 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Ray 编译踩坑记：老版本在老系统上的编译之路</h1>
            
              <p id="updated-time" class="note note-info" style="display: none">
                
                  
                    <!-- compatible with older versions-->
                    本文最后更新于：2025-12-08T23:27:39+08:00
                  
                  

                
              </p>
            
            
              <div class="markdown-body">
                
                <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>Ray 官方提供了<a target="_blank" rel="noopener" href="https://docs.ray.io/en/master/ray-overview/installation.html">安装文档</a>和<a target="_blank" rel="noopener" href="https://docs.ray.io/en/master/ray-contribute/development.html">编译文档</a>，涵盖了多种预构建方案——从稳定的发行版本、到日常构建版本，甚至支持主分支上任意 commit 的构建版本。在多平台、多 Python 版本和多芯片架构的组合下，这些预构建方案在大多数情况下都能满足需求。</p>
<p>但当涉及到在生产环境中维护 HotFix 版本时，从源码编译就成了必不可少的技能。特别是在一些企业环境中，你可能面临的是在 CentOS 8 这样的老系统上，基于 Ray 2.40.0 这样的较早版本进行代码改动和编译。官方的编译文档看起来步骤清晰，但当版本和系统都比较旧的时候，往往会踩到文档没有提及的坑。这些坑有的是版本兼容性问题，有的是系统环境的特殊性导致的，网络上也很难找到现成的解决方案。</p>
<p>面对这些问题，我在 macOS 和 CentOS 8 上编译 Ray 2.40.0 的实践中逐个排查和解决了这些问题，本文记录了其中的关键坑点和解法，希望能给未来有类似编译需求且遇到坑的同学一些帮助。</p>
<h1 id="在-MacBook-上编译-Ray"><a href="#在-MacBook-上编译-Ray" class="headerlink" title="在 MacBook 上编译 Ray"></a>在 MacBook 上编译 Ray</h1><p>我的开发环境是 MacBook M4 Pro。由于本地开发方便，因此我优先在 MacBook 上尝试编译了 Ray，优先探索老版本编译可能遇到的问题。</p>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>参考 Ray 官方的<a target="_blank" rel="noopener" href="https://docs.ray.io/en/master/ray-contribute/development.html">编译文档</a>即可。</p>
<ol>
<li>克隆 Ray 仓库<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> git@github.com:ray-project/ray.git<br><span class="hljs-built_in">cd</span> ray<br></code></pre></td></tr></table></figure></li>
<li>安装 Bazel 编译环境。执行以下命令会通过 bazelisk 安装 v6.5.0 版本的 bazel 到 ~/bin/ 目录。需要手动将 ~/bin/ 加入 PATH 才能访问 bazel 命令。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">brew update<br>brew install wget<br><br>ci/env/install-bazel.sh<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;export PATH=&quot;$PATH:~/bin&quot;&#x27;</span> &gt;&gt; ~/.bashrc<br><span class="hljs-built_in">exec</span> bash<br></code></pre></td></tr></table></figure></li>
<li>在<a target="_blank" rel="noopener" href="https://nodejs.org/zh-cn/download">官网</a>下载安装 Node.js，安装后确保 npm 和 node 命令可用即可。实测较高版本并不会导致编译失败，如果后续编译 dashboard 时遇到问题可回退到官方指定的 Node 版本。</li>
<li>在<a target="_blank" rel="noopener" href="https://www.anaconda.com/">官网</a>下载安装 Anaconda。</li>
<li>使用 Anaconda 创建 Python 环境。为避免潜在的依赖不一致问题，建议 Python 版本与目标环境保持一致。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">conda create -n ray-compile python=3.11.9<br>conda activate ray-compile<br></code></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="编译-2-52-1"><a href="#编译-2-52-1" class="headerlink" title="编译 2.52.1"></a>编译 2.52.1</h2><p>为保证可复现性，我选择基于当前最新正式版本 2.52.1 而非 master 分支的最新 commit 进行编译。</p>
<blockquote>
<p>注意：如果仅修改了 Python 文件，可参考<a target="_blank" rel="noopener" href="https://docs.ray.io/en/master/ray-contribute/development.html#building-ray-python-only">官方文档</a>直接替换 pip 中的 Python 文件即可，无需进行以下复杂的 C++ 编译。</p>
</blockquote>
<ol>
<li>切换到 2.52.1 版本<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git checkout ray-2.52.1<br></code></pre></td></tr></table></figure></li>
<li>编译 dashboard（约 3 分钟）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> python/ray/dashboard/client<br>npm ci<br>npm run build<br></code></pre></td></tr></table></figure></li>
<li>编译 Ray<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> -<br><span class="hljs-built_in">cd</span> python/<br>pip install -r requirements.txt<br>pip install -e . --verbose<br></code></pre></td></tr></table></figure></li>
<li>编译成功，输出如下<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs bash">&gt; python git:(ray-2.52.1) pip install -e . --verbose<br>Using pip 25.3 from /opt/anaconda3/envs/ray-compile/lib/python3.11/site-packages/pip (python 3.11)<br>Obtaining file:///Users/xytan/Desktop/study/ray/python<br>  Running <span class="hljs-built_in">command</span> installing build dependencies<br>  Using pip 25.3 from /opt/anaconda3/envs/ray-compile/lib/python3.11/site-packages/pip (python 3.11)<br>  Collecting setuptools&gt;=40.8.0<br>    Obtaining dependency information <span class="hljs-keyword">for</span> setuptools&gt;=40.8.0 from https://files.pythonhosted.org/packages/a3/dc/17031897dae0efacfea57dfd3a82fdd2a2aeb58e0ff71b77b87e44edc772/setuptools-80.9.0-py3-none-any.whl.metadata<br>    Using cached setuptools-80.9.0-py3-none-any.whl.metadata (6.6 kB)<br>  Using cached setuptools-80.9.0-py3-none-any.whl (1.2 MB)<br>  Installing collected packages: setuptools<br>  Successfully installed setuptools-80.9.0<br>  Installing build dependencies ... <span class="hljs-keyword">done</span><br>  Running <span class="hljs-built_in">command</span> Checking <span class="hljs-keyword">if</span> build backend supports build_editable<br>  Checking <span class="hljs-keyword">if</span> build backend supports build_editable ... <span class="hljs-keyword">done</span><br>  Running <span class="hljs-built_in">command</span> Getting requirements to build editable<br>  Getting requirements to build editable ... <span class="hljs-keyword">done</span><br>  Running <span class="hljs-built_in">command</span> installing backend dependencies<br>  Using pip 25.3 from /opt/anaconda3/envs/ray-compile/lib/python3.11/site-packages/pip (python 3.11)<br>...<br>...<br>...<br>  Building editable <span class="hljs-keyword">for</span> ray (pyproject.toml) ... <span class="hljs-keyword">done</span><br>  Created wheel <span class="hljs-keyword">for</span> ray: filename=ray-2.52.1-0.editable-cp311-cp311-macosx_11_0_arm64.whl size=7592 sha256=95a5cacd0ec290dbca09851988ac9bb0de54c9ddedbee169e7fa8a84428b5e21<br>  Stored <span class="hljs-keyword">in</span> directory: /private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-ephem-wheel-cache-6wzkmjte/wheels/3b/4a/f0/6edffb2ad8c786ba8990ff9495668d930965bc91921b146ea6<br>Successfully built ray<br>Installing collected packages: ray<br>  changing mode of /opt/anaconda3/envs/ray-compile/bin/ray to 755<br>  changing mode of /opt/anaconda3/envs/ray-compile/bin/serve to 755<br>  changing mode of /opt/anaconda3/envs/ray-compile/bin/tune to 755<br>Successfully installed ray-2.52.1<br></code></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="编译-2-40-0"><a href="#编译-2-40-0" class="headerlink" title="编译 2.40.0"></a>编译 2.40.0</h2><p>成功编译 2.52.1 后，下一步尝试编译 2.40.0 版本。</p>
<p>首先执行以下命令，预期编译能够顺利完成：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">git checkout ray-2.40.0<br>pip install -r requirements.txt<br>pip install -e . --verbose<br></code></pre></td></tr></table></figure>
<p>然而出现了以下报错：<code>No module named pip</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs bash">...<br>...<br>...<br>  running build_py<br>  running build_ext<br>  /opt/anaconda3/envs/ray-compile/bin/python3.11: No module named pip<br>  Traceback (most recent call last):<br>    File <span class="hljs-string">&quot;/opt/anaconda3/envs/ray-compile/lib/python3.11/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&quot;</span>, line 389, <span class="hljs-keyword">in</span> &lt;module&gt;<br>      main()<br>    File <span class="hljs-string">&quot;/opt/anaconda3/envs/ray-compile/lib/python3.11/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&quot;</span>, line 373, <span class="hljs-keyword">in</span> main<br>      json_out[<span class="hljs-string">&quot;return_val&quot;</span>] = hook(**hook_input[<span class="hljs-string">&quot;kwargs&quot;</span>])<br>                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^<br>    File <span class="hljs-string">&quot;/opt/anaconda3/envs/ray-compile/lib/python3.11/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&quot;</span>, line 303, <span class="hljs-keyword">in</span> build_editable<br>      <span class="hljs-built_in">return</span> hook(wheel_directory, config_settings, metadata_directory)<br>             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/build_meta.py&quot;</span>, line 468, <span class="hljs-keyword">in</span> build_editable<br>      <span class="hljs-built_in">return</span> self._build_with_temp_dir(<br>             ^^^^^^^^^^^^^^^^^^^^^^^^^^<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/build_meta.py&quot;</span>, line 404, <span class="hljs-keyword">in</span> _build_with_temp_dir<br>      self.run_setup()<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/build_meta.py&quot;</span>, line 512, <span class="hljs-keyword">in</span> run_setup<br>      super().run_setup(setup_script=setup_script)<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/build_meta.py&quot;</span>, line 317, <span class="hljs-keyword">in</span> run_setup<br>      <span class="hljs-built_in">exec</span>(code, locals())<br>    File <span class="hljs-string">&quot;&lt;string&gt;&quot;</span>, line 784, <span class="hljs-keyword">in</span> &lt;module&gt;<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/__init__.py&quot;</span>, line 115, <span class="hljs-keyword">in</span> setup<br>      <span class="hljs-built_in">return</span> distutils.core.setup(**attrs)<br>             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/_distutils/core.py&quot;</span>, line 186, <span class="hljs-keyword">in</span> setup<br>      <span class="hljs-built_in">return</span> run_commands(dist)<br>             ^^^^^^^^^^^^^^^^^^<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/_distutils/core.py&quot;</span>, line 202, <span class="hljs-keyword">in</span> run_commands<br>      dist.run_commands()<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/_distutils/dist.py&quot;</span>, line 1002, <span class="hljs-keyword">in</span> run_commands<br>      self.run_command(cmd)<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/dist.py&quot;</span>, line 1102, <span class="hljs-keyword">in</span> run_command<br>      super().run_command(<span class="hljs-built_in">command</span>)<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/_distutils/dist.py&quot;</span>, line 1021, <span class="hljs-keyword">in</span> run_command<br>      cmd_obj.run()<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/command/editable_wheel.py&quot;</span>, line 139, <span class="hljs-keyword">in</span> run<br>      self._create_wheel_file(bdist_wheel)<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/command/editable_wheel.py&quot;</span>, line 349, <span class="hljs-keyword">in</span> _create_wheel_file<br>      files, mapping = self._run_build_commands(dist_name, unpacked, lib, tmp)<br>                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/command/editable_wheel.py&quot;</span>, line 272, <span class="hljs-keyword">in</span> _run_build_commands<br>      self._run_build_subcommands()<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/command/editable_wheel.py&quot;</span>, line 299, <span class="hljs-keyword">in</span> _run_build_subcommands<br>      self.run_command(name)<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/_distutils/cmd.py&quot;</span>, line 357, <span class="hljs-keyword">in</span> run_command<br>      self.distribution.run_command(<span class="hljs-built_in">command</span>)<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/dist.py&quot;</span>, line 1102, <span class="hljs-keyword">in</span> run_command<br>      super().run_command(<span class="hljs-built_in">command</span>)<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-dszuoqoi/overlay/lib/python3.11/site-packages/setuptools/_distutils/dist.py&quot;</span>, line 1021, <span class="hljs-keyword">in</span> run_command<br>      cmd_obj.run()<br>    File <span class="hljs-string">&quot;&lt;string&gt;&quot;</span>, line 772, <span class="hljs-keyword">in</span> run<br>    File <span class="hljs-string">&quot;&lt;string&gt;&quot;</span>, line 674, <span class="hljs-keyword">in</span> pip_run<br>    File <span class="hljs-string">&quot;&lt;string&gt;&quot;</span>, line 542, <span class="hljs-keyword">in</span> build<br>    File <span class="hljs-string">&quot;/opt/anaconda3/envs/ray-compile/lib/python3.11/subprocess.py&quot;</span>, line 413, <span class="hljs-keyword">in</span> check_call<br>      raise CalledProcessError(retcode, cmd)<br>  subprocess.CalledProcessError: Command <span class="hljs-string">&#x27;[&#x27;</span>/opt/anaconda3/envs/ray-compile/bin/python3.11<span class="hljs-string">&#x27;, &#x27;</span>-m<span class="hljs-string">&#x27;, &#x27;</span>pip<span class="hljs-string">&#x27;, &#x27;</span>install<span class="hljs-string">&#x27;, &#x27;</span>-q<span class="hljs-string">&#x27;, &#x27;</span>--target=/Users/xytan/Desktop/study/ray/python/ray/thirdparty_files<span class="hljs-string">&#x27;, &#x27;</span>psutil<span class="hljs-string">&#x27;, &#x27;</span>setproctitle==1.2.2<span class="hljs-string">&#x27;, &#x27;</span>colorama<span class="hljs-string">&#x27;]&#x27;</span> returned non-zero <span class="hljs-built_in">exit</span> status 1.<br>  An error occurred when building editable wheel <span class="hljs-keyword">for</span> ray.<br>  See debugging tips <span class="hljs-keyword">in</span>: https://setuptools.pypa.io/en/latest/userguide/development_mode.html<span class="hljs-comment">#debugging-tips</span><br>  error: subprocess-exited-with-error<br><br>  × Building editable <span class="hljs-keyword">for</span> ray (pyproject.toml) did not run successfully.<br>  │ <span class="hljs-built_in">exit</span> code: 1<br>  ╰─&gt; No available output.<br><br>  note: This error originates from a subprocess, and is likely not a problem with pip.<br>  full <span class="hljs-built_in">command</span>: /opt/anaconda3/envs/ray-compile/bin/python3.11 /opt/anaconda3/envs/ray-compile/lib/python3.11/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py build_editable /var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/tmp2ifs64vi<br>  cwd: /Users/xytan/Desktop/study/ray/python<br>  Building editable <span class="hljs-keyword">for</span> ray (pyproject.toml) ... error<br>  ERROR: Failed building editable <span class="hljs-keyword">for</span> ray<br>Failed to build ray<br>error: failed-wheel-build-for-install<br><br>× Failed to build installable wheels <span class="hljs-keyword">for</span> some pyproject.toml based projects<br>╰─&gt; ray<br></code></pre></td></tr></table></figure>
<p>遇到该报错后，我检查了 2.40.0 版本的官方<a target="_blank" rel="noopener" href="https://docs.ray.io/en/releases-2.40.0/ray-contribute/development.html">编译文档</a>，确认流程完全符合文档步骤。</p>
<p>按理说，当前 conda 环境应该能找到 python3 和 pip，但调用 <code>pip install -e .</code> 时却报错。查看相关代码后发现，Ray 是通过子进程来安装这些 pip 包的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Note: We are passing in sys.executable so that we use the same</span><br><span class="hljs-comment"># version of Python to build packages inside the build.sh script. Note</span><br><span class="hljs-comment"># that certain flags will not be passed along such as --user or sudo.</span><br><span class="hljs-comment"># TODO(rkn): Fix this.</span><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.getenv(<span class="hljs-string">&quot;SKIP_THIRDPARTY_INSTALL&quot;</span>):<br>    pip_packages = [<span class="hljs-string">&quot;psutil&quot;</span>, <span class="hljs-string">&quot;setproctitle==1.2.2&quot;</span>, <span class="hljs-string">&quot;colorama&quot;</span>]<br>    subprocess.check_call(<br>        [<br>            sys.executable,<br>            <span class="hljs-string">&quot;-m&quot;</span>,<br>            <span class="hljs-string">&quot;pip&quot;</span>,<br>            <span class="hljs-string">&quot;install&quot;</span>,<br>            <span class="hljs-string">&quot;-q&quot;</span>,<br>            <span class="hljs-string">&quot;--target=&quot;</span> + os.path.join(ROOT_DIR, THIRDPARTY_SUBDIR),<br>        ]<br>        + pip_packages,<br>        env=<span class="hljs-built_in">dict</span>(os.environ, CC=<span class="hljs-string">&quot;gcc&quot;</span>),<br>    )<br><br><span class="hljs-comment"># runtime env agent dependenceis</span><br>runtime_env_agent_pip_packages = [<span class="hljs-string">&quot;aiohttp&quot;</span>]<br>subprocess.check_call(<br>    [<br>        sys.executable,<br>        <span class="hljs-string">&quot;-m&quot;</span>,<br>        <span class="hljs-string">&quot;pip&quot;</span>,<br>        <span class="hljs-string">&quot;install&quot;</span>,<br>        <span class="hljs-string">&quot;-q&quot;</span>,<br>        <span class="hljs-string">&quot;--target=&quot;</span> + os.path.join(ROOT_DIR, RUNTIME_ENV_AGENT_THIRDPARTY_SUBDIR),<br>    ]<br>    + runtime_env_agent_pip_packages<br>)<br></code></pre></td></tr></table></figure>
<p>我尝试直接在命令行执行 <code>/opt/anaconda3/envs/ray-compile/bin/python3.11 -m pip install -q --target=/Users/xytan/Desktop/study/ray/python/ray/thirdparty_files psutil setproctitle==1.2.2 colorama</code>，发现可以成功。这说明问题出在子进程执行环境中，可能是子进程初始化时未包含完整的 conda 环境。带着这些上下文，我咨询了 ChatGPT、DeepSeek、Qwen 等大模型，给出的方案包括修改 ~/.bazelrc、将 python 和 pip 加入 /etc/profile 的 PATH 等，但均未能解决问题。</p>
<p>由于对 Ray 编译的复杂度有所顾虑，担心白盒分析耗时不可控，我转而去 Ray 的 issue 区寻找线索。幸运的是找到了一个<a target="_blank" rel="noopener" href="https://github.com/ray-project/ray/issues/42505">相同报错的 issue</a>，遗憾的是该 issue 自 2024 年初创建至今近两年仍未关闭，官方的回复也未给出直接的解决方案，看起来是个棘手的环境问题。</p>
<p>这个问题说来也有些离谱：按照 Ray 官方文档竟然无法从源码编译，这算是个挺严重的问题。不知道 Ray 官方当时构建 2.40.0 版本时是如何操作的，也许是在一个包含所有依赖的沙箱环境中进行，因而未发现此问题。</p>
<p>既然官方也没有提供解决方案，白盒分析又耗时不可控，那有没有高效的黑盒方法来定位问题呢？</p>
<p>我灵机一动：既然 2.52.1 版本可以编译，2.40.0 版本不行，虽然两者相隔<a target="_blank" rel="noopener" href="https://github.com/ray-project/ray/compare/ray-2.40.0...ray-2.52.1">近五千个 commit</a>，但可以用 git bisect 二分查找第一个能编译的 commit。由于不可编译的版本只需执行 <code>pip install -e . --verbose</code> 十秒内就能复现错误，理论上最多 13 次、耗时不到 3 分钟即可定位。</p>
<p>按照这个思路，我先通过 <code>git merge-base ray-2.52.1 ray-2.40.0</code> 获取两个分支的公共祖先 <code>02ac0cdc7adf5e611134840c73fa47dd7866140d</code>。</p>
<p>经测试，ray-2.52.1 可以编译，公共祖先版本不可编译，满足二分条件。</p>
<p>执行 <code>git bisect start ray-2.52.1 02ac0cdc7adf5e611134840c73fa47dd7866140d</code> 开始二分查找。需要注意的是，bisect 默认假定新版本为 bad、旧版本为 good，用于寻找第一个引入 bad 的 commit。而我们的情况恰好相反——新版本可编译、旧版本不可编译，因此在判断 good/bad 时需反向操作。</p>
<p>以下是二分的详细过程，总耗时不超过 5 分钟即定位到第一个使编译成功的 commit：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 只需 11 次即可定位，二分效率惊人</span><br>git bisect start ray-2.52.1 02ac0cdc7adf5e611134840c73fa47dd7866140d<br><span class="hljs-comment"># Bisecting: 2469 revisions left to test after this (roughly 11 steps)</span><br><span class="hljs-comment"># [07f509670a9857d3507fcc9defdc5487d8083758] [data] Refactor interface for actor_pool_map_operator (#53752)</span><br><br><span class="hljs-comment"># git bisect 必须在项目根目录执行，因此退回上级目录，pip install 命令中的路径也相应调整</span><br><span class="hljs-built_in">cd</span> ..<br>pip install -e python --verbose<br><br>git bisect bad<br>pip install -e python --verbose<br><br>git bisect bad<br>pip install -e python --verbose<br><br>git bisect good<br>pip install -e python --verbose<br><br>git bisect bad<br>pip install -e python --verbose<br><br>git bisect good<br>pip install -e python --verbose<br><br>git bisect bad<br>pip install -e python --verbose<br><br>git bisect good<br>pip install -e python --verbose<br><br>git bisect bad<br>pip install -e python --verbose<br><br>git bisect bad<br>pip install -e python --verbose<br><br>git bisect good<br>pip install -e python --verbose<br><br>git bisect bad<br>pip install -e python --verbose<br><br>git bisect bad<br></code></pre></td></tr></table></figure>
<p>出现结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs bash">d2004b6353e131bb67e1bc7f771a09780ee32d2a is the first bad commit<br>commit d2004b6353e131bb67e1bc7f771a09780ee32d2a<br>Author: Philipp Moritz &lt;pcmoritz@gmail.com&gt;<br>Date:   Thu Feb 13 00:08:30 2025 -0800<br><br>    [Core] Initial port of Ray to Python 3.13 (<span class="hljs-comment">#47984)</span><br><br>    &lt;!-- Thank you <span class="hljs-keyword">for</span> your contribution! Please review<br>    https://github.com/ray-project/ray/blob/master/CONTRIBUTING.rst before<br>    opening a pull request. --&gt;<br><br>    &lt;!-- Please add a reviewer to the assignee section when you create a PR.<br>    If you don<span class="hljs-string">&#x27;t have the access to it, we will shortly find a reviewer and</span><br><span class="hljs-string">    assign them to your PR. --&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    ## Why are these changes needed?</span><br><span class="hljs-string"></span><br><span class="hljs-string">    This is the first step towards</span><br><span class="hljs-string">    https://github.com/ray-project/ray/issues/47933</span><br><span class="hljs-string"></span><br><span class="hljs-string">    It is not very tested at the moment (on Python 3.13), but it compiles</span><br><span class="hljs-string">    locally (with `pip install -e . --verbose`) and can execute a simple</span><br><span class="hljs-string">    workload like</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    &gt;&gt;&gt; import ray</span><br><span class="hljs-string">    &gt;&gt;&gt; ray.init()</span><br><span class="hljs-string">    2024-10-10 16:03:31,857 INFO worker.py:1799 -- Started a local Ray instance.</span><br><span class="hljs-string">    RayContext(dashboard_url=&#x27;</span><span class="hljs-string">&#x27;, python_version=&#x27;</span>3.13.0<span class="hljs-string">&#x27;, ray_version=&#x27;</span>3.0.0.dev0<span class="hljs-string">&#x27;, ray_commit=&#x27;</span>&#123;&#123;RAY_COMMIT_SHA&#125;&#125;<span class="hljs-string">&#x27;)</span><br><span class="hljs-string">    &gt;&gt;&gt; @ray.remote</span><br><span class="hljs-string">    ... def f():</span><br><span class="hljs-string">    ...     return 42</span><br><span class="hljs-string">    ...</span><br><span class="hljs-string">    &gt;&gt;&gt; ray.get(f.remote())</span><br><span class="hljs-string">    42</span><br><span class="hljs-string">    &gt;&gt;&gt;</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    (and similar for actors).</span><br><span class="hljs-string"></span><br><span class="hljs-string">    The main thing that needed to change to make Ray work on Python 3.13 was</span><br><span class="hljs-string">    to upgrade Cython to 3.0.11 which seems to be the first version of</span><br><span class="hljs-string">    Cython to support Python 3.13. Unfortunately it has a compiler bug</span><br><span class="hljs-string">    https://github.com/cython/cython/pull/3235 (the fix is not released yet)</span><br><span class="hljs-string">    that I had to work around.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    I also had to work around https://github.com/cython/cython/issues/5750</span><br><span class="hljs-string">    by changing some typing from `float` to `int | float`.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    ## Related issue number</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &lt;!-- For example: &quot;Closes #1234&quot; --&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    ## Checks</span><br><span class="hljs-string"></span><br><span class="hljs-string">    - [ ] I&#x27;</span>ve signed off every commit(by using the -s flag, i.e., `git<br>    commit -s`) <span class="hljs-keyword">in</span> this PR.<br>    - [ ] I<span class="hljs-string">&#x27;ve run `scripts/format.sh` to lint the changes in this PR.</span><br><span class="hljs-string">    - [ ] I&#x27;</span>ve included any doc changes needed <span class="hljs-keyword">for</span><br>    https://docs.ray.io/en/master/.<br>    - [ ] I<span class="hljs-string">&#x27;ve added any new APIs to the API Reference. For example, if I</span><br><span class="hljs-string">    added a</span><br><span class="hljs-string">    method in Tune, I&#x27;</span>ve added it <span class="hljs-keyword">in</span> `doc/source/tune/api/` under the<br>               corresponding `.rst` file.<br>    - [ ] I<span class="hljs-string">&#x27;ve made sure the tests are passing. Note that there might be a</span><br><span class="hljs-string">    few flaky tests, see the recent failures at https://flakey-tests.ray.io/</span><br><span class="hljs-string">    - Testing Strategy</span><br><span class="hljs-string">       - [ ] Unit tests</span><br><span class="hljs-string">       - [ ] Release tests</span><br><span class="hljs-string">       - [ ] This PR is not tested :(</span><br><span class="hljs-string"></span><br><span class="hljs-string">    ---------</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Signed-off-by: Philipp Moritz &lt;pcmoritz@gmail.com&gt;</span><br><span class="hljs-string">    Co-authored-by: pcmoritz &lt;pcmoritz@anyscale.com&gt;</span><br><span class="hljs-string">    Co-authored-by: srinathk10 &lt;68668616+srinathk10@users.noreply.github.com&gt;</span><br><span class="hljs-string">    Co-authored-by: Edward Oakes &lt;ed.nmi.oakes@gmail.com&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string"> bazel/ray_deps_setup.bzl                      |  4 +-</span><br><span class="hljs-string"> python/ray/_raylet.pxd                        |  3 +-</span><br><span class="hljs-string"> python/ray/_raylet.pyx                        | 20 ++++++----</span><br><span class="hljs-string"> python/ray/includes/gcs_client.pxi            | 28 +++++++-------</span><br><span class="hljs-string"> python/ray/includes/global_state_accessor.pxi |  8 ++--</span><br><span class="hljs-string"> python/ray/includes/object_ref.pxi            |  2 +-</span><br><span class="hljs-string"> python/ray/includes/unique_ids.pxd            | 53 +++++++--------------------</span><br><span class="hljs-string"> python/ray/includes/unique_ids.pxi            | 10 ++---</span><br><span class="hljs-string"> python/setup.py                               |  4 +-</span><br><span class="hljs-string"> 9 files changed, 55 insertions(+), 77 deletions(-)</span><br></code></pre></td></tr></table></figure>
<p>分析该 commit 的<a target="_blank" rel="noopener" href="https://github.com/ray-project/ray/commit/d2004b6353e131bb67e1bc7f771a09780ee32d2a">代码</a>，发现这是 AnyScale CTO 为 Ray 添加 Python 3.13 支持的改动，遗憾的是 PR 描述中并未提及任何编译问题的修复，应该是无意间修复了此问题。</p>
<p>因此只能深入代码寻找原因。幸运的是这个 PR 只修改了 9 个文件、不到 100 行代码，可以较直观地分析为何这个 commit 使编译得以成功。</p>
<p>经排查，发现该 commit 在 setup.py 中只修改了两行代码，其中关键的一行是为 setup_requires 增加了 pip 依赖。这个改动与之前的报错高度吻合：setup_requires 正是用于在子进程中初始化构建依赖的。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-meta">@@ -807,7 +807,7 @@</span> setuptools.setup(<br>     # The BinaryDistribution argument triggers build_ext.<br>     distclass=BinaryDistribution,<br>     install_requires=setup_spec.install_requires,<br><span class="hljs-deletion">-    setup_requires=[&quot;cython &gt;= 0.29.32&quot;, &quot;wheel&quot;],</span><br><span class="hljs-addition">+    setup_requires=[&quot;cython &gt;= 3.0.12&quot;, &quot;pip&quot;, &quot;wheel&quot;],</span><br>     extras_require=setup_spec.extras,<br>     entry_points=&#123;<br></code></pre></td></tr></table></figure>
<p>找到原因后，我立即切换到 ray-2.40.0 分支并在 setup.py 中添加 pip 依赖，改动如下：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/python/setup.py b/python/setup.py</span><br><span class="hljs-comment">index 16017fa544..28ffef2503 100644</span><br><span class="hljs-comment">--- a/python/setup.py</span><br><span class="hljs-comment">+++ b/python/setup.py</span><br><span class="hljs-meta">@@ -807,7 +807,7 @@</span> setuptools.setup(<br>     # The BinaryDistribution argument triggers build_ext.<br>     distclass=BinaryDistribution,<br>     install_requires=setup_spec.install_requires,<br><span class="hljs-deletion">-    setup_requires=[&quot;cython &gt;= 0.29.32&quot;, &quot;wheel&quot;],</span><br><span class="hljs-addition">+    setup_requires=[&quot;cython &gt;= 0.29.32&quot;, &quot;pip&quot;, &quot;wheel&quot;],</span><br>     extras_require=setup_spec.extras,<br>     entry_points=&#123;<br>         &quot;console_scripts&quot;: [<br></code></pre></td></tr></table></figure>
<p>执行 <code>pip install -e python --verbose</code> 后，之前的报错消失了，说明改动生效。但不幸的是又出现了新的报错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs bash">[2,597 / 5,261] Executing genrule @com_github_antirez_redis//:bin; 3s <span class="hljs-built_in">local</span> ... (12 actions, 10 running)<br>  ERROR: /private/var/tmp/_bazel_xytan/13505f911ec68d8fcfe382f9a26054b3/external/zlib/BUILD.bazel:1:11: Compiling zutil.c failed: (Exit 1): cc_wrapper.sh failed: error executing <span class="hljs-built_in">command</span> (from target @zlib//:zlib)<br>    (<span class="hljs-built_in">cd</span> /private/var/tmp/_bazel_xytan/13505f911ec68d8fcfe382f9a26054b3/sandbox/darwin-sandbox/12269/execroot/com_github_ray_project_ray &amp;&amp; \<br>    <span class="hljs-built_in">exec</span> <span class="hljs-built_in">env</span> - \<br>      PATH=/Users/xytan/Library/Caches/bazelisk/downloads/bazelbuild/bazel-6.5.0-darwin-arm64/bin:/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/bin:/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/normal/bin:/Users/xytan/.local/bin:/opt/anaconda3/envs/ray-compile/bin:/opt/anaconda3/condabin:/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/System/Cryptexes/App/usr/bin:/usr/bin:/bin:/usr/sbin:/sbin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/local/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/appleinternal/bin:/opt/pmk/env/global/bin:/Applications/iTerm.app/Contents/Resources/utilities:/Library/Java/JavaVirtualMachines/zulu-11.jdk/Contents/Home/bin:/usr/local/maven/bin:/Users/xytan/bin:/Library/Java/JavaVirtualMachines/zulu-11.jdk/Contents/Home/bin:/usr/local/maven/bin:/Users/xytan/bin \<br>      PWD=/proc/self/cwd \<br>    external/local_config_cc/cc_wrapper.sh -U_FORTIFY_SOURCE -fstack-protector -Wall -Wthread-safety -Wself-assign -Wunused-but-set-parameter -Wno-free-nonheap-object -fcolor-diagnostics -fno-omit-frame-pointer -g0 -O2 <span class="hljs-string">&#x27;-D_FORTIFY_SOURCE=1&#x27;</span> -DNDEBUG -ffunction-sections -fdata-sections -MD -MF bazel-out/darwin_arm64-opt/bin/external/zlib/_objs/zlib/zutil.pic.d <span class="hljs-string">&#x27;-frandom-seed=bazel-out/darwin_arm64-opt/bin/external/zlib/_objs/zlib/zutil.pic.o&#x27;</span> -fPIC <span class="hljs-string">&#x27;-DBAZEL_CURRENT_REPOSITORY=&quot;zlib&quot;&#x27;</span> -iquote external/zlib -iquote bazel-out/darwin_arm64-opt/bin/external/zlib -isystem external/zlib -isystem bazel-out/darwin_arm64-opt/bin/external/zlib -fPIC -Werror -w <span class="hljs-string">&#x27;-Wno-error=implicit-function-declaration&#x27;</span> -no-canonical-prefixes -Wno-builtin-macro-redefined <span class="hljs-string">&#x27;-D__DATE__=&quot;redacted&quot;&#x27;</span> <span class="hljs-string">&#x27;-D__TIMESTAMP__=&quot;redacted&quot;&#x27;</span> <span class="hljs-string">&#x27;-D__TIME__=&quot;redacted&quot;&#x27;</span> -c external/zlib/zutil.c -o bazel-out/darwin_arm64-opt/bin/external/zlib/_objs/zlib/zutil.pic.o)<br>  <span class="hljs-comment"># Configuration: 5f13e584be259b429338435560124496342d10ebccdd9918322724af70f69ddb</span><br>  <span class="hljs-comment"># Execution platform: @local_config_platform//:host</span><br><br>  Use --sandbox_debug to see verbose messages from the sandbox and retain the sandbox build root <span class="hljs-keyword">for</span> debugging<br>  In file included from external/zlib/zutil.c:10:<br>  In file included from external/zlib/gzguts.h:21:<br>  In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/stdio.h:61:<br>  /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/_stdio.h:318:7: error: expected identifier or <span class="hljs-string">&#x27;(&#x27;</span><br>    318 | FILE    *fdopen(int, const char *) __DARWIN_ALIAS_STARTING(__MAC_10_6, __IPHONE_2_0, __DARWIN_ALIAS(fdopen));<br>        |          ^<br>  external/zlib/zutil.h:147:33: note: expanded from macro <span class="hljs-string">&#x27;fdopen&#x27;</span><br>    147 | <span class="hljs-comment">#        define fdopen(fd,mode) NULL /* No fdopen() */</span><br>        |                                 ^<br>  /Library/Developer/CommandLineTools/usr/lib/clang/17/include/__stddef_null.h:26:16: note: expanded from macro <span class="hljs-string">&#x27;NULL&#x27;</span><br>     26 | <span class="hljs-comment">#define NULL ((void*)0)</span><br>        |                ^<br>  In file included from external/zlib/zutil.c:10:<br>  In file included from external/zlib/gzguts.h:21:<br>  In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/stdio.h:61:<br>  /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/_stdio.h:318:7: error: expected <span class="hljs-string">&#x27;)&#x27;</span><br>  external/zlib/zutil.h:147:33: note: expanded from macro <span class="hljs-string">&#x27;fdopen&#x27;</span><br>    147 | <span class="hljs-comment">#        define fdopen(fd,mode) NULL /* No fdopen() */</span><br>        |                                 ^<br>  /Library/Developer/CommandLineTools/usr/lib/clang/17/include/__stddef_null.h:26:16: note: expanded from macro <span class="hljs-string">&#x27;NULL&#x27;</span><br>     26 | <span class="hljs-comment">#define NULL ((void*)0)</span><br>        |                ^<br>  /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/_stdio.h:318:7: note: to match this <span class="hljs-string">&#x27;(&#x27;</span><br>  external/zlib/zutil.h:147:33: note: expanded from macro <span class="hljs-string">&#x27;fdopen&#x27;</span><br>    147 | <span class="hljs-comment">#        define fdopen(fd,mode) NULL /* No fdopen() */</span><br>        |                                 ^<br>  /Library/Developer/CommandLineTools/usr/lib/clang/17/include/__stddef_null.h:26:15: note: expanded from macro <span class="hljs-string">&#x27;NULL&#x27;</span><br>     26 | <span class="hljs-comment">#define NULL ((void*)0)</span><br>        |               ^<br>  In file included from external/zlib/zutil.c:10:<br>  In file included from external/zlib/gzguts.h:21:<br>  In file included from /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/stdio.h:61:<br>  /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/_stdio.h:318:7: error: expected <span class="hljs-string">&#x27;)&#x27;</span><br>    318 | FILE    *fdopen(int, const char *) __DARWIN_ALIAS_STARTING(__MAC_10_6, __IPHONE_2_0, __DARWIN_ALIAS(fdopen));<br>        |          ^<br>  external/zlib/zutil.h:147:33: note: expanded from macro <span class="hljs-string">&#x27;fdopen&#x27;</span><br>    147 | <span class="hljs-comment">#        define fdopen(fd,mode) NULL /* No fdopen() */</span><br>        |                                 ^<br>  /Library/Developer/CommandLineTools/usr/lib/clang/17/include/__stddef_null.h:26:22: note: expanded from macro <span class="hljs-string">&#x27;NULL&#x27;</span><br>     26 | <span class="hljs-comment">#define NULL ((void*)0)</span><br>        |                      ^<br>  /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/_stdio.h:318:7: note: to match this <span class="hljs-string">&#x27;(&#x27;</span><br>  external/zlib/zutil.h:147:33: note: expanded from macro <span class="hljs-string">&#x27;fdopen&#x27;</span><br>    147 | <span class="hljs-comment">#        define fdopen(fd,mode) NULL /* No fdopen() */</span><br>        |                                 ^<br>  /Library/Developer/CommandLineTools/usr/lib/clang/17/include/__stddef_null.h:26:14: note: expanded from macro <span class="hljs-string">&#x27;NULL&#x27;</span><br>     26 | <span class="hljs-comment">#define NULL ((void*)0)</span><br>        |              ^<br>  3 errors generated.<br>  INFO: Elapsed time: 6.329s, Critical Path: 4.04s<br>  INFO: 512 processes: 360 internal, 152 darwin-sandbox.<br>  FAILED: Build did NOT complete successfully<br>  Traceback (most recent call last):<br>    File <span class="hljs-string">&quot;/opt/anaconda3/envs/ray-compile/lib/python3.11/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&quot;</span>, line 389, <span class="hljs-keyword">in</span> &lt;module&gt;<br>      main()<br>    File <span class="hljs-string">&quot;/opt/anaconda3/envs/ray-compile/lib/python3.11/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&quot;</span>, line 373, <span class="hljs-keyword">in</span> main<br>      json_out[<span class="hljs-string">&quot;return_val&quot;</span>] = hook(**hook_input[<span class="hljs-string">&quot;kwargs&quot;</span>])<br>                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^<br>    File <span class="hljs-string">&quot;/opt/anaconda3/envs/ray-compile/lib/python3.11/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&quot;</span>, line 303, <span class="hljs-keyword">in</span> build_editable<br>      <span class="hljs-built_in">return</span> hook(wheel_directory, config_settings, metadata_directory)<br>             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/build_meta.py&quot;</span>, line 468, <span class="hljs-keyword">in</span> build_editable<br>      <span class="hljs-built_in">return</span> self._build_with_temp_dir(<br>             ^^^^^^^^^^^^^^^^^^^^^^^^^^<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/build_meta.py&quot;</span>, line 404, <span class="hljs-keyword">in</span> _build_with_temp_dir<br>      self.run_setup()<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/build_meta.py&quot;</span>, line 512, <span class="hljs-keyword">in</span> run_setup<br>      super().run_setup(setup_script=setup_script)<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/build_meta.py&quot;</span>, line 317, <span class="hljs-keyword">in</span> run_setup<br>      <span class="hljs-built_in">exec</span>(code, locals())<br>    File <span class="hljs-string">&quot;&lt;string&gt;&quot;</span>, line 784, <span class="hljs-keyword">in</span> &lt;module&gt;<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/__init__.py&quot;</span>, line 115, <span class="hljs-keyword">in</span> setup<br>      <span class="hljs-built_in">return</span> distutils.core.setup(**attrs)<br>             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/_distutils/core.py&quot;</span>, line 186, <span class="hljs-keyword">in</span> setup<br>      <span class="hljs-built_in">return</span> run_commands(dist)<br>             ^^^^^^^^^^^^^^^^^^<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/_distutils/core.py&quot;</span>, line 202, <span class="hljs-keyword">in</span> run_commands<br>      dist.run_commands()<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/_distutils/dist.py&quot;</span>, line 1002, <span class="hljs-keyword">in</span> run_commands<br>      self.run_command(cmd)<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/dist.py&quot;</span>, line 1102, <span class="hljs-keyword">in</span> run_command<br>      super().run_command(<span class="hljs-built_in">command</span>)<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/_distutils/dist.py&quot;</span>, line 1021, <span class="hljs-keyword">in</span> run_command<br>      cmd_obj.run()<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/command/editable_wheel.py&quot;</span>, line 139, <span class="hljs-keyword">in</span> run<br>      self._create_wheel_file(bdist_wheel)<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/command/editable_wheel.py&quot;</span>, line 349, <span class="hljs-keyword">in</span> _create_wheel_file<br>      files, mapping = self._run_build_commands(dist_name, unpacked, lib, tmp)<br>                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/command/editable_wheel.py&quot;</span>, line 272, <span class="hljs-keyword">in</span> _run_build_commands<br>      self._run_build_subcommands()<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/command/editable_wheel.py&quot;</span>, line 299, <span class="hljs-keyword">in</span> _run_build_subcommands<br>      self.run_command(name)<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/_distutils/cmd.py&quot;</span>, line 357, <span class="hljs-keyword">in</span> run_command<br>      self.distribution.run_command(<span class="hljs-built_in">command</span>)<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/dist.py&quot;</span>, line 1102, <span class="hljs-keyword">in</span> run_command<br>      super().run_command(<span class="hljs-built_in">command</span>)<br>    File <span class="hljs-string">&quot;/private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-build-env-v2znngb3/overlay/lib/python3.11/site-packages/setuptools/_distutils/dist.py&quot;</span>, line 1021, <span class="hljs-keyword">in</span> run_command<br>      cmd_obj.run()<br>    File <span class="hljs-string">&quot;&lt;string&gt;&quot;</span>, line 772, <span class="hljs-keyword">in</span> run<br>    File <span class="hljs-string">&quot;&lt;string&gt;&quot;</span>, line 674, <span class="hljs-keyword">in</span> pip_run<br>    File <span class="hljs-string">&quot;&lt;string&gt;&quot;</span>, line 617, <span class="hljs-keyword">in</span> build<br>    File <span class="hljs-string">&quot;&lt;string&gt;&quot;</span>, line 397, <span class="hljs-keyword">in</span> bazel_invoke<br>    File <span class="hljs-string">&quot;/opt/anaconda3/envs/ray-compile/lib/python3.11/subprocess.py&quot;</span>, line 413, <span class="hljs-keyword">in</span> check_call<br>      raise CalledProcessError(retcode, cmd)<br>  subprocess.CalledProcessError: Command <span class="hljs-string">&#x27;[&#x27;</span>bazel<span class="hljs-string">&#x27;, &#x27;</span>build<span class="hljs-string">&#x27;, &#x27;</span>--verbose_failures<span class="hljs-string">&#x27;, &#x27;</span>--<span class="hljs-string">&#x27;, &#x27;</span>//:ray_pkg<span class="hljs-string">&#x27;, &#x27;</span>//cpp:ray_cpp_pkg<span class="hljs-string">&#x27;]&#x27;</span> returned non-zero <span class="hljs-built_in">exit</span> status 1.<br>  An error occurred when building editable wheel <span class="hljs-keyword">for</span> ray.<br>  See debugging tips <span class="hljs-keyword">in</span>: https://setuptools.pypa.io/en/latest/userguide/development_mode.html<span class="hljs-comment">#debugging-tips</span><br>  error: subprocess-exited-with-error<br><br>  × Building editable <span class="hljs-keyword">for</span> ray (pyproject.toml) did not run successfully.<br>  │ <span class="hljs-built_in">exit</span> code: 1<br>  ╰─&gt; No available output.<br><br>  note: This error originates from a subprocess, and is likely not a problem with pip.<br>  full <span class="hljs-built_in">command</span>: /opt/anaconda3/envs/ray-compile/bin/python3.11 /opt/anaconda3/envs/ray-compile/lib/python3.11/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py build_editable /var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/tmpq2o3yp9s<br>  cwd: /Users/xytan/Desktop/study/ray/python<br>  Building editable <span class="hljs-keyword">for</span> ray (pyproject.toml) ... error<br>  ERROR: Failed building editable <span class="hljs-keyword">for</span> ray<br>Failed to build ray<br>error: failed-wheel-build-for-install<br><br>× Failed to build installable wheels <span class="hljs-keyword">for</span> some pyproject.toml based projects<br>╰─&gt; ray<br></code></pre></td></tr></table></figure>
<p>通过搜索，找到了 Bazel 仓库中一个<a target="_blank" rel="noopener" href="https://github.com/bazelbuild/bazel/issues/25124">相同报错的 issue</a>。原因是新版本 macOS SDK 与 Bazel 依赖的 zlib 1.3 不兼容，需升级到 zlib 1.3.1 版本。</p>
<p>于是我按照 issue 中的描述在 WORKSPACE 文件中添加了以下配置，遗憾的是仍然报错：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">zlib_version = <span class="hljs-string">&quot;1.3.1&quot;</span><br><br>zlib_sha256 = <span class="hljs-string">&quot;9a93b2b7dfdac77ceba5a558a580e74667dd6fede4585b91eefb60f03b72df23&quot;</span><br><br>http_archive(<br>    name = <span class="hljs-string">&quot;zlib&quot;</span>,<br>    build_file = <span class="hljs-string">&quot;@com_google_protobuf//:third_party/zlib.BUILD&quot;</span>,<br>    sha256 = zlib_sha256,<br>    strip_prefix = <span class="hljs-string">&quot;zlib-%s&quot;</span> % zlib_version,<br>    urls = [<span class="hljs-string">&quot;https://github.com/madler/zlib/releases/download/v&#123;v&#125;/zlib-&#123;v&#125;.tar.gz&quot;</span>.<span class="hljs-built_in">format</span>(v = zlib_version)],<br>)<br></code></pre></td></tr></table></figure>
<p>白盒分析暂时没有头绪。既然如此，只能继续用二分方案黑盒查找。这次由于需要编译数分钟才能复现，二分过程会稍慢一些，但仍可行。</p>
<p>经过 11 轮二分，定位到了使编译通过的 <a target="_blank" rel="noopener" href="https://github.com/ray-project/ray/commit/65ae6076f25325528dabf1432d1ff1bedb1c70b3">commit</a>。从 PR 标题来看，该 commit 正是为了解决 macOS 编译问题：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs tap">65ae6076f25325528dabf1432d1ff1bedb1c70b3 is the first bad commit<br>commit 65ae6076f25325528dabf1432d1ff1bedb1c70b3<br>Author: Dhyey Shah &lt;dhyey2019@gmail.com&gt;<br>Date:   Mon Apr<span class="hljs-number"> 7 </span>12:41:34<span class="hljs-number"> 2025 </span>-0400<br><br>    [core] Patch zlib and clang<span class="hljs-number"> 17 </span>compliant for mac update (<span class="hljs-comment">#52020)</span><br><br>    Signed-off-by: dayshah &lt;dhyey2019@gmail.com&gt;<br><br> .bazelrc                                        | <span class="hljs-number"> 2 </span>+-<br> bazel/ray.bzl                                   | <span class="hljs-number"> 4 </span>++++<br> bazel/ray_deps_setup.bzl                        | <span class="hljs-number"> 2 </span>++<br> src/ray/core_worker/core_worker.h               | <span class="hljs-number"> 9 </span>+++++++--<br> thirdparty/patches/grpc-zlib-fdopen.patch       |<span class="hljs-number"> 13 </span>+++++++++++++<br> thirdparty/patches/prometheus-zlib-fdopen.patch |<span class="hljs-number"> 11 </span>+++++++++++<br> thirdparty/patches/zlib-fdopen.patch            |<span class="hljs-number"> 19 </span>+++++++++++++++++++<br><span class="hljs-number"> 7 </span>files changed,<span class="hljs-number"> 57 </span>insertions(+),<span class="hljs-number"> 3 </span>deletions(-)<br> create mode<span class="hljs-number"> 100644 </span>thirdparty/patches/grpc-zlib-fdopen.patch<br> create mode<span class="hljs-number"> 100644 </span>thirdparty/patches/prometheus-zlib-fdopen.patch<br> create mode<span class="hljs-number"> 100644 </span>thirdparty/patches/zlib-fdopen.patch<br></code></pre></td></tr></table></figure>
<p>切回 ray-2.40.0 版本，执行 <code>git cherry-pick 65ae6076f25325528dabf1432d1ff1bedb1c70b3</code> 将该 commit cherry-pick 过来（需处理小范围冲突，可参考我个人维护的 release/2.40.0 <a target="_blank" rel="noopener" href="https://github.com/OneSizeFitsQuorum/ray/tree/release/2.40.0">版本</a>），再补充 setup.py 中的 pip 依赖，即可在新版本 macOS 上成功编译 ray-2.40.0。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs bash">ray git:(6e726cac4f) ✗ pip install -e python --verbose<br>Using pip 25.3 from /opt/anaconda3/envs/ray-compile-1/lib/python3.11/site-packages/pip (python 3.11)<br>Obtaining file:///Users/xytan/Desktop/study/ray/python<br>  Running <span class="hljs-built_in">command</span> installing build dependencies<br>  Using pip 25.3 from /opt/anaconda3/envs/ray-compile-1/lib/python3.11/site-packages/pip (python 3.11)<br>  Collecting setuptools&gt;=40.8.0<br>    Obtaining dependency information <span class="hljs-keyword">for</span> setuptools&gt;=40.8.0 from https://files.pythonhosted.org/packages/a3/dc/17031897dae0efacfea57dfd3a82fdd2a2aeb58e0ff71b77b87e44edc772/setuptools-80.9.0-py3-none-any.whl.metadata<br>    Using cached setuptools-80.9.0-py3-none-any.whl.metadata (6.6 kB)<br>  Using cached setuptools-80.9.0-py3-none-any.whl (1.2 MB)<br>  Installing collected packages: setuptools<br>  Successfully installed setuptools-80.9.0<br>  Installing build dependencies ... <span class="hljs-keyword">done</span><br>  Running <span class="hljs-built_in">command</span> Checking <span class="hljs-keyword">if</span> build backend supports build_editable<br>  Checking <span class="hljs-keyword">if</span> build backend supports build_editable ... <span class="hljs-keyword">done</span><br>  Running <span class="hljs-built_in">command</span> Getting requirements to build editable<br>  Getting requirements to build editable ... <span class="hljs-keyword">done</span><br>  Running <span class="hljs-built_in">command</span> installing backend dependencies<br>  Using pip 25.3 from /opt/anaconda3/envs/ray-compile-1/lib/python3.11/site-packages/pip (python 3.11)<br>  Collecting pip<br>    Obtaining dependency information <span class="hljs-keyword">for</span> pip from https://files.pythonhosted.org/packages/44/3c/d717024885424591d5376220b5e836c2d5293ce2011523c9de23ff7bf068/pip-25.3-py3-none-any.whl.metadata<br>    Using cached pip-25.3-py3-none-any.whl.metadata (4.7 kB)<br>  Collecting wheel<br>    Obtaining dependency information <span class="hljs-keyword">for</span> wheel from https://files.pythonhosted.org/packages/0b/2c/87f3254fd8ffd29e4c02732eee68a83a1d3c346ae39bc6822dcbcb697f2b/wheel-0.45.1-py3-none-any.whl.metadata<br>    Using cached wheel-0.45.1-py3-none-any.whl.metadata (2.3 kB)<br>  Collecting cython&gt;=0.29.32<br>    Obtaining dependency information <span class="hljs-keyword">for</span> cython&gt;=0.29.32 from https://files.pythonhosted.org/packages/e0/ba/d785f60564a43bddbb7316134252a55d67ff6f164f0be90c4bf31482da82/cython-3.2.2-cp311-cp311-macosx_11_0_arm64.whl.metadata<br>    Using cached cython-3.2.2-cp311-cp311-macosx_11_0_arm64.whl.metadata (5.0 kB)<br>  Using cached pip-25.3-py3-none-any.whl (1.8 MB)<br>  Using cached wheel-0.45.1-py3-none-any.whl (72 kB)<br>  Using cached cython-3.2.2-cp311-cp311-macosx_11_0_arm64.whl (3.0 MB)<br>  ...<br>  ...<br>  ...<br>  Building editable <span class="hljs-keyword">for</span> ray (pyproject.toml) ... <span class="hljs-keyword">done</span><br>  Created wheel <span class="hljs-keyword">for</span> ray: filename=ray-2.40.0-0.editable-cp311-cp311-macosx_11_0_arm64.whl size=7304 sha256=5b09461aeadadc13af4d10af9d5c78e4a55a52718113de72f0b02bbeb485c5c3<br>  Stored <span class="hljs-keyword">in</span> directory: /private/var/folders/xx/j9ztcfr55_d_3p24y1v_4mzw0000gn/T/pip-ephem-wheel-cache-njomx5v1/wheels/3b/4a/f0/6edffb2ad8c786ba8990ff9495668d930965bc91921b146ea6<br>Successfully built ray<br>Installing collected packages: ray<br>  Attempting uninstall: ray<br>    Found existing installation: ray 2.52.1<br>    Uninstalling ray-2.52.1:<br>      Removing file or directory /opt/anaconda3/envs/ray-compile-1/bin/ray<br>      Removing file or directory /opt/anaconda3/envs/ray-compile-1/bin/serve<br>      Removing file or directory /opt/anaconda3/envs/ray-compile-1/bin/tune<br>      Removing file or directory /opt/anaconda3/envs/ray-compile-1/lib/python3.11/site-packages/__editable__.ray-2.52.1.pth<br>      Removing file or directory /opt/anaconda3/envs/ray-compile-1/lib/python3.11/site-packages/__editable___ray_2_52_1_finder.py<br>      Removing file or directory /opt/anaconda3/envs/ray-compile-1/lib/python3.11/site-packages/__pycache__/__editable___ray_2_52_1_finder.cpython-311.pyc<br>      Removing file or directory /opt/anaconda3/envs/ray-compile-1/lib/python3.11/site-packages/ray-2.52.1.dist-info/<br>      Successfully uninstalled ray-2.52.1<br>  changing mode of /opt/anaconda3/envs/ray-compile-1/bin/ray to 755<br>  changing mode of /opt/anaconda3/envs/ray-compile-1/bin/rllib to 755<br>  changing mode of /opt/anaconda3/envs/ray-compile-1/bin/serve to 755<br>  changing mode of /opt/anaconda3/envs/ray-compile-1/bin/tune to 755<br>Successfully installed ray-2.40.0<br></code></pre></td></tr></table></figure>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>在 macOS 上编译 ray-2.52.1 和 ray-2.40.0 的过程中，遇到了两个棘手问题：第一个是找不到 pip 的问题，官方 issue、PR 和网络资料均无解决方案；第二个是 zlib 版本兼容问题，虽然在 issue 中找到了疑似方案，但尝试后未能奏效。</p>
<p>在白盒分析无果的情况下，我决定使用 git bisect 黑盒定位。得益于 O(log n) 相比 O(n) 的效率优势，成功在近五千个 commit 中高效找到了使 ray-2.40.0 能够编译的两个关键 commit。</p>
<p>通过这次排查，我将基于 release/2.40.0 版本新增的两个修复 commit 推送到了 <a target="_blank" rel="noopener" href="https://github.com/OneSizeFitsQuorum/ray/tree/release/2.40.0">GitHub</a>，同时也将本文的发现回复在了近两年未关闭的 <a target="_blank" rel="noopener" href="https://github.com/ray-project/ray/issues/42505">issue</a> 中并使得 issue 被 resolve 关闭，希望后来遇到这些坑的朋友能从中受益。</p>
<h1 id="在-CentOS-8-上编译-Ray"><a href="#在-CentOS-8-上编译-Ray" class="headerlink" title="在 CentOS 8 上编译 Ray"></a>在 CentOS 8 上编译 Ray</h1><p>完成 MacBook 上的编译探索后，接下来在 CentOS 8 上编译 Ray。相比之前遇到的代码层面问题，这部分更多是环境配置的挑战。</p>
<p>由于 CentOS 8 已于 2021 年底停止维护，主流云厂商的官方镜像中已不再提供该版本，最低可选版本为 CentOS Stream 9：<br><img src="/ray-compile/centos.png" srcset="/img/loading.gif" lazyload alt></p>
<p>Ubuntu 同样如此，最低可选版本为 Ubuntu 22.04，无法直接获取 Ubuntu 16 等老版本镜像：<br><img src="/ray-compile/ubuntu.png" srcset="/img/loading.gif" lazyload alt></p>
<p>虽然基于这些新版本镜像也能编译 Ray，但由于其 glibc 等核心库版本较高，编译产物往往无法在老版本系统上运行。</p>
<p>因此，若需为老版本操作系统编译 HotFix，推荐的做法是：在云厂商处租用相同 CPU 架构的较新版本机器，然后通过 Docker 拉取 CentOS 或 Ubuntu 官方提供的老版本镜像进行编译，以此确保编译环境与生产环境的一致性。</p>
<p>基于以上分析，我在 Google Cloud 上租用了一台 x86 架构的 CentOS Stream 9 机器进行后续编译。</p>
<h2 id="环境配置-1"><a href="#环境配置-1" class="headerlink" title="环境配置"></a>环境配置</h2><ol>
<li>按上述要求从云厂商处申请机器，通过 SSH 登录</li>
<li>安装 Docker<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo yum install docker<br></code></pre></td></tr></table></figure></li>
<li>拉取目标版本的 CentOS 镜像并进入容器<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -it centos:8.1.1911 /bin/bash<br></code></pre></td></tr></table></figure></li>
<li><p>由于 CentOS 8 官方源已停止服务，需在容器内配置可用的 yum 源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">sed -i <span class="hljs-string">&#x27;s|mirrorlist=|#mirrorlist=|g&#x27;</span> /etc/yum.repos.d/CentOS-*.repo<br>sed -i <span class="hljs-string">&#x27;s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g&#x27;</span> /etc/yum.repos.d/CentOS-*.repo<br><br>yum clean all<br>yum makecache<br></code></pre></td></tr></table></figure>
</li>
<li><p>安装 Node.js</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash<br><span class="hljs-built_in">exec</span> bash<br>nvm install 14<br>nvm use 14<br></code></pre></td></tr></table></figure>
</li>
<li><p>克隆 Ray 仓库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y git<br>git <span class="hljs-built_in">clone</span> https://github.com/onesizefitsquorum/ray.git<br><span class="hljs-built_in">cd</span> ray<br></code></pre></td></tr></table></figure>
</li>
<li><p>安装 C++ 编译工具链</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum groupinstall <span class="hljs-string">&#x27;Development Tools&#x27;</span><br>yum install psmisc<br>ci/env/install-bazel.sh<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;export PATH=&quot;$PATH:~/bin&quot;&#x27;</span> &gt;&gt; ~/.bashrc<br><span class="hljs-built_in">exec</span> bash<br></code></pre></td></tr></table></figure>
</li>
<li><p>安装 Anaconda</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install wget<br>wget https://repo.anaconda.com/archive/Anaconda3-2025.06-1-Linux-x86_64.sh<br>sh Anaconda3-2025.06-1-Linux-x86_64.sh<br><span class="hljs-built_in">exec</span> bash<br></code></pre></td></tr></table></figure>
</li>
<li><p>创建并激活 Python 环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">conda create -n ray-compile python=3.11.9<br>conda activate ray-compile<br></code></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="编译-HotFix-分支"><a href="#编译-HotFix-分支" class="headerlink" title="编译 HotFix 分支"></a>编译 HotFix 分支</h2><ol>
<li>切换到维护的 HotFix 分支<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git checkout release/2.40.0<br></code></pre></td></tr></table></figure></li>
<li>编译 Dashboard<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> python/ray/dashboard/client<br>npm ci<br>npm run build<br></code></pre></td></tr></table></figure></li>
<li>编译 Ray<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> -<br><span class="hljs-built_in">cd</span> python/<br>pip install -r requirements.txt<br>pip install -e . --verbose<br></code></pre></td></tr></table></figure></li>
<li>编译失败。需要继续探索原因。</li>
</ol>
<p>这期间的若干尝试主要有以下三类报错：</p>
<ol>
<li><p>GLIBC 安全检查与外部依赖冲突（Fortify 越界）</p>
<ul>
<li>这个问题是由于 Ray 的外部依赖库 (@upb) 采取的内存操作方式，与系统的高版本 GLIBC 引入的严格安全检查（_FORTIFY_SOURCE）冲突导致的。</li>
<li>报错日志片段（关键信息）：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">error: <span class="hljs-string">&#x27;__builtin_memcpy(...)&#x27;</span> forming offset [9, 16] is out of the bounds [0, 8] of object <span class="hljs-string">&#x27;value&#x27;</span> ... [-Werror=array-bounds]<br></code></pre></td></tr></table></figure></li>
<li>问题根源与修改原因： 该错误是 upb 库在进行内存复制时，触发了 GLIBC 的 _FORTIFY_SOURCE 机制的 array-bounds 警告，并且该警告被 Bazel 的编译选项 -Werror 升级为错误。由于 upb 库的编译规则（特别是针对 Bazel Host 工具时）强制定义了 -D_FORTIFY_SOURCE=1，同时又强制使用了 -Werror，覆盖了我们的外部参数。 因此，需要指定 BAZEL_ARGS 来强制覆盖这些编译选项：<ul>
<li>—host_copt=-U_FORTIFY_SOURCE —copt=-U_FORTIFY_SOURCE：取消定义 _FORTIFY_SOURCE 宏，绕过严格的安全检查。</li>
<li>—host_copt=-Wno-error —copt=-Wno-error：禁用将警告升级为错误的行为，防止 upb 编译失败。</li>
</ul>
</li>
</ul>
</li>
<li><p>Bazel 配置文件强制执行 -Werror 导致的编译失败</p>
<ul>
<li><p>即使我们通过 BAZEL_ARGS 传递了 -Wno-error，Ray 源码中的 Bazel 配置文件（.bazelrc）仍有更高级别的规则强制应用 -Werror，这导致了像 implicit-fallthrough 这样的 C++ 警告升级为错误。</p>
</li>
<li><p>报错日志片段（关键信息）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">src/ray/common/id.cc: In <span class="hljs-keyword">function</span> <span class="hljs-string">&#x27;uint64_t ray::MurmurHash64A(const void*, int, unsigned int)&#x27;</span>:<br>src/ray/common/id.cc:106:7: error: this statement may fall through [-Werror=implicit-fallthrough=]<br>...<br>cc1plus: all warnings being treated as errors<br></code></pre></td></tr></table></figure></li>
<li>问题根源与修改原因： Ray 的 C++ 代码在 MurmurHash64A 等函数中使用了 switch 语句的 Fall-through（自然落入） 结构，这种结构在 GCC 中会触发 -Wimplicit-fallthrough 警告。由于 Ray 源码根目录下的 .bazelrc 文件中存在一条高优先级的配置规则，例如 build:linux —per_file_copt=”…”-Werror，这条规则将所有警告都升级为了错误。命令行参数无法覆盖这条规则。因此，需要手动进入 .bazelrc 文件，将该行配置（即强制添加 -Werror 的项）注释掉，才能允许这些警告存在，从而使核心代码编译通过。</li>
</ul>
</li>
<li><p>GCC 版本不兼容导致的 C++ 歧义错误</p>
<ul>
<li>这个问题发生在尝试使用 Ray 2.40.0 版本的源代码时。Ray 的 C++ 代码库是基于较新的 C++ 标准（如 C++17）编写的，而系统默认 GCC 版本（可能是 GCC 8.x 或更早）在处理新标准的一些特性时存在缺陷。</li>
<li>报错日志片段（关键信息）：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">error: ambiguous overload <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;operator&lt;&lt;&#x27;</span> (operand types are <span class="hljs-string">&#x27;std::ostringstream&#x27;</span> &#123;aka <span class="hljs-string">&#x27;std::__cxx11::basic_ostringstream&lt;char&gt;&#x27;</span>&#125; and <span class="hljs-string">&#x27;std::nullptr_t&#x27;</span>)<br></code></pre></td></tr></table></figure></li>
<li>问题根源与修改原因： 该错误是经典的 nullptr_t 歧义问题。在 Ray 的日志宏（RayLog）中，尝试将 nullptr（类型为 std::nullptr_t）输出到 std::ostringstream。旧版 GCC（如 GCC 8.x 的标准库）对 std::nullptr_t 没有明确的 operator&lt;&lt; 重载，导致编译器无法区分它是应该被当作 bool 还是 const void*，因此报告歧义错误。将 GCC 版本升级到 11.2.1 能够解决此问题，因为新版本的 GCC 标准库完善了对 C++17 特性的支持，消除了这种类型转换的歧义。</li>
</ul>
</li>
</ol>
<p>通过在 GitHub 和 Ray 问答社区中进行搜索，并结合 Gemini 和 ChatGPT 的多轮问答结果，在踩坑十余次、折腾许久后，最终一一解决。</p>
<p>解决方案有三：</p>
<ol>
<li>升级 gcc 版本到 11.2.1：可以看到在官网<a target="_blank" rel="noopener" href="https://docs.ray.io/en/releases-2.40.0/ray-contribute/development.html">编译文档</a>中 Ubuntu 上推荐的编译器版本为 clang12，但却没有说明推荐的 gcc 版本。实测升级到 11.2.1 版本的 GCC 能够编译通过。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install gcc-toolset-11<br>scl <span class="hljs-built_in">enable</span> gcc-toolset-11 bash<br><span class="hljs-comment"># 注意需要重新切换 conda 环境</span><br>conda activate ray-compile<br></code></pre></td></tr></table></figure></li>
<li>设置 BAZEL_ARGS 环境变量<ul>
<li><code>-U_FORTIFY_SOURCE</code>: 禁用 Fortify 检查，解决 upb/memcpy 越界问题。</li>
<li><code>-Wno-error</code>: 禁用将警告升级为错误，避免外部依赖因严格的警告而失败。</li>
<li><code>--host_copt / --host_cxxopt</code>: 确保这些豁免规则应用于 Bazel 编译工具链（即 Host 平台）。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> BAZEL_ARGS=<span class="hljs-string">&quot;--host_copt=-U_FORTIFY_SOURCE --copt=-U_FORTIFY_SOURCE --host_copt=-Wno-error --copt=-Wno-error --host_cxxopt=-Wno-error --cxxopt=-Wno-error&quot;</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li>修改 Ray .bazelrc 代码中的编译选项：尽管我们设置了 BAZEL_ARGS，但 Ray 源码目录下的 .bazelrc 文件中包含的 build:linux —per_file_copt=”…-Werror” 规则具有极高的优先级，强制将 implicit-fallthrough 等警告升级为错误。需要手动将其注释。<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-comment">diff --git a/.bazelrc b/.bazelrc</span><br><span class="hljs-comment">index 3c84ce36a7..84a5b3fa7a 100644</span><br><span class="hljs-comment">--- a/.bazelrc</span><br><span class="hljs-comment">+++ b/.bazelrc</span><br><span class="hljs-meta">@@ -43,10 +43,10 @@</span> build:windows --enable_runfiles<br> #                 for compiling assembly files is fixed on Windows:<br> #                 https://github.com/bazelbuild/bazel/issues/8924<br> # Warnings should be errors<br><span class="hljs-deletion">-build:linux    --per_file_copt=&quot;-\\.(asm|S)$@-Werror&quot;</span><br><span class="hljs-deletion">-build:macos    --per_file_copt=&quot;-\\.(asm|S)$@-Werror&quot;</span><br><span class="hljs-deletion">-build:clang-cl --per_file_copt=&quot;-\\.(asm|S)$@-Werror&quot;</span><br><span class="hljs-deletion">-build:msvc-cl     --per_file_copt=&quot;-\\.(asm|S)$@-WX&quot;</span><br><span class="hljs-addition">+# build:linux    --per_file_copt=&quot;-\\.(asm|S)$@-Werror&quot;</span><br><span class="hljs-addition">+# build:macos    --per_file_copt=&quot;-\\.(asm|S)$@-Werror&quot;</span><br><span class="hljs-addition">+# build:clang-cl --per_file_copt=&quot;-\\.(asm|S)$@-Werror&quot;</span><br><span class="hljs-addition">+# build:msvc-cl     --per_file_copt=&quot;-\\.(asm|S)$@-WX&quot;</span><br> # Ignore warnings for protobuf generated files and external projects.<br> build --per_file_copt=&quot;\\.pb\\.cc$@-w&quot;<br> build:linux --per_file_copt=&quot;-\\.(asm|S)$,external/.*@-w,-Wno-error=implicit-function-declaration,-Wno-error=unused-function&quot;<br></code></pre></td></tr></table></figure>
</li>
</ol>
<p>完成以上修改后，即可成功执行 <code>pip install -e . --verbose</code> 完成编译。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">...<br>...<br>...<br>  Options like `package-data`, `include/exclude-package-data` or<br>  `packages.find.exclude/include` may have no effect.<br><br>  adding <span class="hljs-string">&#x27;__editable___ray_2_40_0_finder.py&#x27;</span><br>  adding <span class="hljs-string">&#x27;__editable__.ray-2.40.0.pth&#x27;</span><br>  creating <span class="hljs-string">&#x27;/tmp/pip-ephem-wheel-cache-rq0i6oso/wheels/3b/a3/3e/5871189f4113432e73b7e4659ab9a4d2edef3998a6dcfea06f/tmp5xknhp72/.tmp-_9ctuqe5/ray-2.40.0-0.editable-cp311-cp311-linux_x86_64.whl&#x27;</span> and adding <span class="hljs-string">&#x27;/tmp/tmpr9lwou7pray-2.40.0-0.editable-cp311-cp311-linux_x86_64.whl&#x27;</span> to it<br>  adding <span class="hljs-string">&#x27;ray-2.40.0.dist-info/METADATA&#x27;</span><br>  adding <span class="hljs-string">&#x27;ray-2.40.0.dist-info/WHEEL&#x27;</span><br>  adding <span class="hljs-string">&#x27;ray-2.40.0.dist-info/entry_points.txt&#x27;</span><br>  adding <span class="hljs-string">&#x27;ray-2.40.0.dist-info/top_level.txt&#x27;</span><br>  adding <span class="hljs-string">&#x27;ray-2.40.0.dist-info/RECORD&#x27;</span><br>  /tmp/pip-build-env-mlv1uqa4/overlay/lib/python3.11/site-packages/setuptools/command/editable_wheel.py:351: InformationOnly: Editable installation.<br>  !!<br><br>          ********************************************************************************<br>          Please be careful with folders <span class="hljs-keyword">in</span> your working directory with the same<br>          name as your package as they may take precedence during imports.<br>          ********************************************************************************<br><br>  !!<br>    with strategy, WheelFile(wheel_path, <span class="hljs-string">&quot;w&quot;</span>) as wheel_obj:<br>  Building editable <span class="hljs-keyword">for</span> ray (pyproject.toml) ... <span class="hljs-keyword">done</span><br>  Created wheel <span class="hljs-keyword">for</span> ray: filename=ray-2.40.0-0.editable-cp311-cp311-linux_x86_64.whl size=7272 sha256=18b317c847a6088a316df5f5c98bda8e245fb62cd7acb720a374447e4b94646c<br>  Stored <span class="hljs-keyword">in</span> directory: /tmp/pip-ephem-wheel-cache-rq0i6oso/wheels/3b/a3/3e/5871189f4113432e73b7e4659ab9a4d2edef3998a6dcfea06f<br>Successfully built ray<br>Installing collected packages: ray<br>  changing mode of /root/anaconda3/envs/ray-compile/bin/ray to 755<br>  changing mode of /root/anaconda3/envs/ray-compile/bin/rllib to 755<br>  changing mode of /root/anaconda3/envs/ray-compile/bin/serve to 755<br>  changing mode of /root/anaconda3/envs/ray-compile/bin/tune to 755<br>Successfully installed ray-2.40.0<br></code></pre></td></tr></table></figure></p>
<p>下一步也可以使用 <code>pip wheel . --verbose</code> 来打包成 wheel 供其它环境安装使用。</p>
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><p>与 macOS 上的编译经历类似，CentOS 8 上的编译同样遇到了不少坑。除了需要通过 Docker 确保编译环境与生产环境一致外，还需解决三个编译问题：GCC 版本过低导致的 <code>nullptr_t</code> 歧义错误、GLIBC Fortify 安全检查与外部依赖冲突、以及 <code>.bazelrc</code> 强制启用 <code>-Werror</code> 导致的编译失败。最终通过升级 GCC 到 11.2.1、设置 <code>BAZEL_ARGS</code> 环境变量、以及注释 <code>.bazelrc</code> 中的 <code>-Werror</code> 配置，成功完成编译。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文记录了在 macOS 和 CentOS 8 上编译 Ray 2.40.0 的完整踩坑过程，共解决了五个关键问题：</p>
<p><strong>macOS 编译问题：</strong></p>
<ol>
<li><strong>pip 模块缺失</strong>：Ray 2.43 之前的版本编译时报 <code>No module named pip</code>，需在 <code>setup.py</code> 的 <code>setup_requires</code> 中添加 pip 依赖，详见 <a target="_blank" rel="noopener" href="https://github.com/OneSizeFitsQuorum/ray/commit/af79598849f579ceb148fa65ec82e45c69749a74">commit</a>。</li>
<li><strong>zlib 兼容性问题</strong>：Ray 2.45 之前的版本在新版 macOS 上因 zlib 版本不兼容而编译失败，需 cherry-pick 此 <a target="_blank" rel="noopener" href="https://github.com/OneSizeFitsQuorum/ray/commit/6e726cac4ff0f52e849743e27ba1ebc4d4055de6">commit</a> 修复。</li>
</ol>
<p><strong>CentOS 8 编译问题：</strong></p>
<ol>
<li><strong>GCC 版本过低</strong>：CentOS 8 默认的 GCC 8.x 在处理 C++17 特性时存在 <code>nullptr_t</code> 歧义问题，需升级到 GCC 11.2.1。</li>
<li><strong>GLIBC Fortify 冲突</strong>：外部依赖库 upb 的内存操作与 GLIBC 的 <code>_FORTIFY_SOURCE</code> 安全检查冲突，需通过 <code>BAZEL_ARGS</code> 禁用相关检查。</li>
<li><strong>-Werror 强制启用</strong>：<code>.bazelrc</code> 中的 <code>-Werror</code> 配置将警告升级为错误，需手动注释相关配置行。详见 <a target="_blank" rel="noopener" href="https://github.com/OneSizeFitsQuorum/ray/commit/138ff9d96e42097801cb50159c5f0afa7464c612">commit</a>。</li>
</ol>
<p>以上修复已合并到我维护的 <a target="_blank" rel="noopener" href="https://github.com/OneSizeFitsQuorum/ray/commits/release/2.40.0/">release/2.40.0 分支</a>，同时也已将解决方案回复到社区 <a target="_blank" rel="noopener" href="https://github.com/ray-project/ray/issues/42505">issue</a> 中并使得 issue 被 resolve 掉，希望能帮助后来者少走弯路。</p>
<p>至此，本文所有内容均已结束，感谢您的阅读和关注！</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E9%85%8D%E7%BD%AE/" class="print-no-link">#开发工具配置</a>
      
        <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97/" class="print-no-link">#分布式计算</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Ray 编译踩坑记：老版本在老系统上的编译之路</div>
      <div>https://tanxinyu.work/ray-compile/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>谭新宇</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年12月6日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025-annual-summary/" title="2025 年终总结：从时序数据库到 AI Infra 的转身">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">2025 年终总结：从时序数据库到 AI Infra 的转身</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/code-server-with-ray-distributed-debugger/" title="让 Ray Distributed Debugger 在 Kuberay 下可用">
                        <span class="hidden-mobile">让 Ray Distributed Debugger 在 Kuberay 下可用</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'OneSizeFitsQuorum/OneSizeFitsQuorum.github.io');
      s.setAttribute('issue-term', 'title');
      
      s.setAttribute('label', 'blog comments');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  var relativeDate = function() {
    var updatedTime = document.getElementById('updated-time');
    if (updatedTime) {
      var text = updatedTime.textContent;
      var reg = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-]\d{2}:\d{2})/;
      var matchs = text.match(reg);
      if (matchs) {
        var relativeTime = moment(matchs[0]).fromNow();
        updatedTime.textContent = text.replace(reg, relativeTime);
      }
      updatedTime.style.display = '';
    }
  };
  Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/moment.min.js', function() {
    if (!'zh-cn'.startsWith('en')) {
      Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/locale/zh-cn.min.js', function() {
        relativeDate();
      });
    } else {
      relativeDate();
    }
  });
</script>


  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/haruto.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body>
</html>
